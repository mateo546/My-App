name: Deploy-Kubernetes
on:
  push:
    branches: [develop]

jobs:
  Build-And-Push:
    runs-on: ubuntu-latest
    env:
      container_name: pokeapp_web
      image_name: pokeapp
      tag_image: lts
      container_port: 80

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '19.7.0'

      - name: Install Dependencies
        run: npm install

      #- name: use actions
       # uses: ./.github/docker-action

      - name: Build Docker Image
        run: docker build -t ${{ env.image_name }}:${{ env.tag_image }} --file dockerfile .

      - name: Login to DockerHub
        run: docker login -u ${{ secrets.DOCKERHUB_USER }} -p ${{ secrets.DOCKERHUB_PASSWORD }}

      - name: Push Docker Image
        run: |
          docker tag ${{ env.image_name }}:${{ env.tag_image }} mateocolombo/pokeapp:${{ env.tag_image }}
          docker push mateocolombo/pokeapp:${{ env.tag_image }}
         # docker rmi ${{ env.image_name }}:${{ env.tag_image }}

  Push-To-Kubernetes:
    runs-on: ubuntu-latest
    #needs: ["Build-And-Push"]
    env:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}    
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }} 
      #CLUSTER_TOKEN: ${{ secrets.CLUSTER_TOKEN }}
      POKEAPP_KEY: ${{ secrets.POKEAPP_KEY }}
      POKEAPP_CRT: ${{ secrets.POKEAPP_CRT }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '19.7.0'
      
      - name: Install
        run: npm install

      - name: Azure Login
        run: |
          kubectl config set-cluster ModeloDevops-AKS --server=https://modelodevops-aks-dns-b137e13a.hcp.westeurope.azmk8s.io
          kubectl config set-context ModeloDevops-AKS-Admin --cluster=ModeloDevops-AKS --namespace=mateo-pokeapp-dev 
          kubectl config set clusters.ModeloDevops-AKS.certificate-authority-data LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUU2RENDQXRDZ0F3SUJBZ0lRVnoxR0ZRZ1M0QVhtWmNjV2NrYlZyREFOQmdrcWhraUc5dzBCQVFzRkFEQU4KTVFzd0NRWURWUVFERXdKallUQWdGdzB5TWpBMk1EWXlNalUwTURsYUdBOHlNRFV5TURZd05qSXpNRFF3T1ZvdwpEVEVMTUFrR0ExVUVBeE1DWTJFd2dnSWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUNEd0F3Z2dJS0FvSUNBUUR5CkVVNUo1bG16dFVOK1RnVWozWG5MSlZCWTVjeklocDllVExMR1IyYWdFNUN4TXhoZVc4d0h1d251WC9hQWFkbFQKcThncU1NdGVudzA4WlMxbWtzUHJkaUNpZU8ramtMa0gyajdtb21VUmt3WkVldXl1bUVxOHhralVqcFUweUs2NAo3bTRlcTh6U2ZLRld3SDIyOFJnOG5LYm1mbnRibkJ1cWFndTlzdm5IK3pJL2VINWxhWHhoYklyWVBTYXJDMXBaCnQyeStFd3p1R1BoNkZtaWYva2VyaDIwMzh2NGdpRlZFSTJFN0VaTlFTcklKZTRPMU5lWnFyUTFIQjNHZExmWEEKbDdqNTlTcFBiaWpZNkQ5MDJKb2kycStmUXBMRjFDcXkyQlhqdVphWm1kb091UXVMM3I0aTFnWGMyMHpTMkR5awp1TkhFbkpxdHJ3djIweTRDelF4OWJMV3FWRjVNemVhd0R0WWxjN2ZESCtLTUtoZmZYM3lmZmZka3ZiZWtieW9JCkMwWHBrcjZZc05uMXVPWWVmSGMzZmhEWWNUVTdVdWxMRG1jVGlydEJVS0cvdHk1UTV4NjFLaUdrUTUvV2tSM2cKZk9ZWjIxdkNEellKRTJubWdBRmJEaWROZTNmVmlZYWJtVGVQVm5UYkJqUjFFaGN2OGJNSytmRmZsSzh4UU1MRQpUa2dqZFFVYXJJaDkxUUZRVWpub2dRQ2dudjZQVFlPblN2bVI4a09QbnU5Z3NmNVRxb3RXN1hmWGR2NmFObmNvCmVDV1FkK2IxWVlLM0svemx1T1VZSWpGS2h3aWxrSVNNamJIMm1vSnVzY0FNejZxSm83NkwzeGU1WURUZnhVMDgKdnhPMmVRenBoRTlEUGdkYmNXM1lwVHRwcTdnZk5IeUdWcVJ0ZzJBY1V3SURBUUFCbzBJd1FEQU9CZ05WSFE4QgpBZjhFQkFNQ0FxUXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QWRCZ05WSFE0RUZnUVVIWndnMDNsT1ZhcXVENC8zCkRWWnFuWXkzMWUwd0RRWUpLb1pJaHZjTkFRRUxCUUFEZ2dJQkFDcDFtNGRKcnh3ZlBoRkN0Z0lnQkxxZWNaa2wKY3ZPempJZFpPa29PME90Qm9UcGR1bmp2WWx6ZEY3Z2RUUHI4Z0pSc2VRamQ1SHNnT1puTWhydEROMXJXcUp6aQo4ODluc3FreXpibmViaTJ4TjljR0ZKTERocGdRblB4c2lFS2VNMHpaengxS3BiL2R0aFhzL1dMQ0dJSWdORkhYCmR0WFdQZWs1MCtZVHU1dDU5cjVrNHBSZGppblRmMUpoRjEydjZpVkIzK3JyOEJTbmJPZW4xN08rZk9uTXJrWmgKN09uYUVDTVpQRFpQQnBvZURkanlOM3VJU3lpRWxMdGJPaUtzTUNMWEZVNW9WQ3czVGk5SVpEaldHVlVZaHlNOQp0MHlzU05XTzZ4ZUJFQkMrZk1zSzkwTGRsU2pwZWpWSVduUUlJUC9vVnpOcjVLL3JtSEdTQzJWRDYvYXgyRGVECmRwOStwQU1rVVdUSlhBanFDNXErZHVydGpKazdSZ0hVdXdFcytadFNBVlQyOGZQNUpaVkpWSUFZZjErUjZNeUkKdTlDOWs5NWxuMUJEelJqMWRuR3Fjc1RJbk1teW80VWV2R2VhMFVzams5ZS9KNDA2ZDY5MjlhRlF6MWN4RFI4dgpSNGZLTzJRbTNaRkZvV1B5a0tnL0g5eThZQjVDT1RwT2svWXZkWlBTUlpVeFJHVHVoNjJDdXl0RE9waDNwakY5ClA1NzBlQVJEVVBxTC9UTjRzL0l2UFFaTFFVbDZZT3k0cDhZN3VUSmlISXJRZGJLUWF1NjlMRC9sa09UeER3R0kKRnBvK3hlaXc3dGJ6NGp2Q3d5b0lROFdMUnlrZVhaMndsZzJ0RFh1ZG5XQk4rNXJ0c09KNnhqWGg3SnJETmNBbApnbFQ3NlhuUlRmWGUwV1ZSCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K
          kubectl config set-credentials mateo --token=${{ secrets.CLUSTER_TOKEN }} 
          kubectl config set-context ModeloDevops-AKS-Admin --user=mateo
          kubectl config use-context ModeloDevops-AKS-Admin
          kubectl apply -k kustomize

      - name: Update Kubernetes Secrets
        run: |
          sed -i 's|_pokeapp_key_|LS0tLS1CRUdJTiBQUklWQVRFIEtFWS0tLS0tCk1JSUpRd0lCQURBTkJna3Foa2lHOXcwQkFRRUZBQVNDQ1Mwd2dna3BBZ0VBQW9JQ0FRQytCekdCejBYL2ZyNUYKY0JVTjludmVEY25oTjRyRjh4dDJLWHR6SVZEVlgxWHUzN3dJZnMvbW1VR0c0ZjhqVEkrNzVMaml0QzNTMTFSbwpvcHMzeHA1VFZ5ZnhIRnRFUUEzMEluQ1NObXNPZVorOTkrUXY5UU1XcTVVcXBCQkMvSUpoOVZvWlJ3SkhXaEVNCjY3aWlEeUo1OXYyWmJRckdRV2o3UkRIcmcxanlqa05GQjJ1QXpsUm5hUWh6UHU4Y1Y5TU5pQ09MSFh5U2NOMmgKSEQza0NkVWkyUnFRN1Vsb2tkYTRFS0Jiem1tQ2YvWTdGSG9pUndxYWdERkFLSkNFc2lhV00zR001RVFMOHpxegpkTzVJdGVOMUN0RGF0RjRiWGxGMXBZRVRWSHFicGt1c1U5NzR4RE1RZGZFNXBtc0pXSWQwWVRXZHZIQi9HU05KCkdtUERMa011UXRaOGFoeUR6NzJXMGY5eTJvSjVRSHR4dVhtRVhwZFNFQ1ovNmcvZEZEVG5RNFpXRjdBU3NjZHQKVEVtSXpnZVpXZkRlUGh5Mmw1dmxaRWpwMTJCMGVySFA5MDd0WXpJWnRQOVZUdGVKODEvOGdaNmZ4Q21vMVlMUQpOR1FtellKRzJlWW0rNU5zOHlIYldqRDlBUzAxOFphY3BOZGlJOFlDelpuS09CT2U5V2xlNDk2NXVSakZIamc2CiswRmphUlZKU3dFN3IxQmNqektRMzEwdUdpYi9xMElxdTB2a3MzRkZZb2pKM25ZWmhZWjZ1N3BtanVSSnlmNVkKajluM0FCNHlOM1ZsdWk4a2ZmalBWR0FNMStmbFlWTzZxbTIzN3NXSDk3T3NCQTdQM1czbTJsS1JRK1oxSDNlZQpuU1p4WXdJNWNEVkpvTmd5VWpXMG5XUlY1TTd1Y1FJREFRQUJBb0lDQUN1bWp0eDg3cDBaTWQ5VTl2MHBXcnhBCkNoamlMNDQzZ1I0a09yK1FUbGRwS2gzd1JtcmtLR0VWNEx1NVk2aHA0SlYrWFdyMERSZWl6M2ltcTRXRktoN0cKUlQ1Skwzek93dlhLeUhXSnF3OWM2RkVVcFpYUGtBbFAyamk4amFDNWpNQ3dRYVZQVHFweHVidHdWVTNpc0o1NApHanA1VmhHQytuakhhamtwaDQvV0ZvVS9obFlFNzFYK3hrcGswVHUvUDlPYXEyRjhJVDZwVHZ2QWQwWVA3U1h2ClhYOGZocTZPMjVZVithUUZGdTc3Y21ZUlZ0blRYRS92dFFDQ0lPcGVXdWREUTJqa0VXNTJUWXhtQm90c3ZxWkcKMlFGNEQ2cjFRRHlJUzAxVHFVTmlVSDB5R2VTbWV2MWp2a2pxSGFtOHJJYlRBcVFzWW1JTHRmT0hySlZyNWRIUAp5dFZTRkNSNHVQMzNMcUcxVkN2RkxnbGhuMlcvd0lCZ25jeDR4WXo0TEFIS0Z4Uzc2RDViR25XeUtoWXFnK0ZhClhGZGhvVU1YcUZDMFEvVkhGaFUrNUFBOHVEMERTRndJUUJxaFRjcXNzd013bDdBMzQ2ZXJSN3FxY1N1OUtvKy8KZTZMN1Z5dEZMYTNSb3drbDRKNnRId0xFNyt6ekFBNnkwcjlNdEdoc0tyNEF3K0gzZ2lsaXR5dzlLbXF4d1o0ZAo1Z2NTUEYrUjRBUXVkL0xaRHg4RGtJVDZqWUZrVGNXbmt1ZkZ0M3BCYlVpSWNjYmN3V2ZLTVEvc2JwZkhvYTBXCmdnSGNScUZtd2xyM0ZuL0JMVTJiemZFTENyU0xPVWFGQ2pFbEo0TWJIc3VjdFJXVDlOcWU1WFhqZ2JLcUVlWTMKV0Q4cTI4VHVGV0Q2cWhRcmdQeDlBb0lCQVFEcnBta2ZqRHcwUURlUlZ2bHBCU3BESURaZUFRZ0xBYllUbTJucQp5TjdGU1d6bXNoL3VHbGJBSUhnekVkUS9YU2dISXNTVUlqbDYzazNRNnhrYWx2b1M5RVZhajM3V05nbTdCY1ZWCnRBVXRTUEs2L0dLc0JnTHUrMDRUbG13bUc3ZkJnN0VmK1A5b3ZvTExUSEF4dkJyU3BpQjNHRVVqWDdNTGo2TUQKVy9JUEZmblo1cVQ3RDRmenp6c2g2OW5ZUnFjVndhaFo5d0Q4azZIL0V1am9xdVZQMDdQWTA3LzdkVHB5Y2NVUQpTb0FCZjVkT2xGbEZTaGJncUNGYTF1d2E3MmEwUVJsMkdTY1lTb0QrSG5wRFh2ZDIwY21Za1E2VUNOTllqQjBSCmpiMGxiQm94alFLTnE3b1dEUGQzU0d6aUpqL1ZSSnozdnhrbXpnTk4xU1JKcmZVMUFvSUJBUURPY0RSRUNkcGcKZ3g3eHo5OTZyczM5dERvejF2RnB1ODhwV21sUktUcng1ZEgyaTRzQmN1Y3g1N01SME1lNWdWa0JsL2JsdkliUQpxVHNUSG9lcFI3eGdrWXJzVXVqUU1QS0dvWGt5UThHdGpYZmg4QWNhQU9OMHY5OXpGeFByeVRseG1IMmFwQlNvClBMeGFFOE9vWDBWWE1IWGFpWFd0SHZuTGJXeEhDR05qclRFYTVDSmZzcC83QXZLc05taFVrdVdLS0N3MGtYdDQKWHpTT0Yrdk9OcUdoVFFnUXBKSURuZEZjYVd0L1dmTzBTWEtCQW5qTlYwN3I3SkNhYzZBN0ZMU1BtRjMycVZxRAozV3hxY1I4bm1EVTRtM0dLTWQxTlcyMTRrZ21Pb0QwNXBjZlNQVjNqcWdQdDdqNFhMNktkK0pYcG5Yc1JRNllhCk5BMFdRRDd3M0tmTkFvSUJBRmh1b0xDWUhkZTE2YVIvTVNXNkxIdjRVSzdDVUZSaEZnVVJvNVBhUWM5am1KeVMKWiswZ3NVRjBiZWNzWDZ4UHR6L0dTbU1VM09GQkg0NnhTMEJ4Ty9OMCs3bmFjOHpMaHFkS3FSMWFhejd0U3puawprTnJoZnFSVVpwNXZLcks2WUNFYzNKR1ZEYlF2R2tKVXN4M1c2M0gxcWVWSGxGcU1CVkxuV2xOZVk5NUpidlBZCjNEempQUysvcXY4MTFSQ1dvd2xGSFhwMWVVZFAxOUV6TlhocStaY1ZhVDZMYUZaalRjVzQ4QzBHNkRhbnZRNWUKR1lvcEhhQzlONWN4WkhWUE5nbWJESVVITjJha1B2Z2VVOStJZWZGN0ZONU9RVnhJVzVlMUxRdHpWM0g5dVc2eQo3aXhnTDNzcTdvc3pBTGwxaFNyeGpyNWlWbnY3ZjczcnFLeUZ2YWtDZ2dFQkFJKzRPZ3JzT1NaYjR0MUNkVGw2CkhWcjFjRmZLMnNOYnh6dm8vODFMUVFoTGtjTnRIdGRoWVdlekFVM3o1amhWdnR1SEtwS0NqL0VSQUZtdE5aRTYKcWdFcEVtaTR4L0M1UXY5THg0Nmc4V09jUzh2MlNWdG5Kdk9PNlVlODExZWQvZW9CMmVBaFAyaG84RkJkMWllUQpQRHdaTnROd1E0YkZPKzdPUFVXdXAxTXJyallrZ1hIU2IrSlhDUSt2eVM2b0hqbnpBZU9QTFVCK041NTlOT09aCjBTajA4aHAwR0Z1QU1kTithU0orUTFaT2svTVEvMzBsdllJdWJmVzViZUh6NWtqYU1RQ2Fvck9QSWYxd3g5bk8KODY1M09iS1dTSldrZ3pBZnE1dXFIelhWSHFwVm90bnU4VkZpUGNQeW0rb1N1SHV0OFpIeFlPQjVRR3N2U3lKdwozRGtDZ2dFQkFPSkI5QWQ1RnVablVBdTI4N3gzYTQ0NWtZV1V3eVJIWGdYQjRzOFJ6Z3RIcWNaaUJlNVlLRVhuCnVxbFBTZ3pBTDB6cVRZVm5sejNjYzhwQzZJa2R1TVpJWGFkOWZtYmh3TWNNT2ZqaVdvOVBOUFpTaGZOL0pkRnUKcmh2a281WFlJQ2xhQzc2QytHUVl6RExYQktWS3R1QStVQVhwUGZ3TDIyNU9EenRrYnVSOHVRUFU0VW4rVDNtaQpQaWM5TGd1cTJTUlB4V0JVZWtISXlqSjVYeXMyU2REcVNUWGF2c0t4U1JRQU52d2kzODk0ejd2Qk5WZ0JsMWdoClR6bHBrZ2s2emJ4b0lFanFzWHpicDJwOEMyOThtSzdyZ2c5Tjc5SlJ5dDJMaTNDa0RQVm5vY2NYRGo0clljdUIKUitNWFBsdHNaRE0reVZRczR5NlVyVk9TMDJsRkh5UT0KLS0tLS1FTkQgUFJJVkFURSBLRVktLS0tLQo=|g' kustomize/secret.yaml --debug"
          sed -i 's|_pokeapp_crt_|LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUZPVENDQXlHZ0F3SUJBZ0lVV1p2ZksrMThxSW9tRDIwVjlYelMrUGhrV3N3d0RRWUpLb1pJaHZjTkFRRUwKQlFBd0xERXFNQ2dHQTFVRUF3d2hiV0YwWlc4dWJXOWtaV3h2WkdWMmIzQnpMbk52WTJsMWMyTm9hV3hsTG1OcwpNQjRYRFRJek1EUXlOREF3TVRjME1sb1hEVEkwTURReU16QXdNVGMwTWxvd0xERXFNQ2dHQTFVRUF3d2hiV0YwClpXOHViVzlrWld4dlpHVjJiM0J6TG5OdlkybDFjMk5vYVd4bExtTnNNSUlDSWpBTkJna3Foa2lHOXcwQkFRRUYKQUFPQ0FnOEFNSUlDQ2dLQ0FnRUF2Z2N4Z2M5Ri8zNitSWEFWRGZaNzNnM0o0VGVLeGZNYmRpbDdjeUZRMVY5Vgo3dCs4Q0g3UDVwbEJodUgvSTB5UHUrUzQ0clF0MHRkVWFLS2JOOGFlVTFjbjhSeGJSRUFOOUNKd2tqWnJEbm1mCnZmZmtML1VERnF1VktxUVFRdnlDWWZWYUdVY0NSMW9SRE91NG9nOGllZmI5bVcwS3hrRm8rMFF4NjROWThvNUQKUlFkcmdNNVVaMmtJY3o3dkhGZlREWWdqaXgxOGtuRGRvUnc5NUFuVkl0a2FrTzFKYUpIV3VCQ2dXODVwZ24vMgpPeFI2SWtjS21vQXhRQ2lRaExJbWxqTnhqT1JFQy9NNnMzVHVTTFhqZFFyUTJyUmVHMTVSZGFXQkUxUjZtNlpMCnJGUGUrTVF6RUhYeE9hWnJDVmlIZEdFMW5ieHdmeGtqU1Jwand5NURMa0xXZkdvY2c4KzlsdEgvY3RxQ2VVQjcKY2JsNWhGNlhVaEFtZitvUDNSUTA1ME9HVmhld0VySEhiVXhKaU00SG1WbnczajRjdHBlYjVXUkk2ZGRnZEhxeAp6L2RPN1dNeUdiVC9WVTdYaWZOZi9JR2VuOFFwcU5XQzBEUmtKczJDUnRubUp2dVRiUE1oMjFvdy9RRXROZkdXCm5LVFhZaVBHQXMyWnlqZ1RudlZwWHVQZXVia1l4UjQ0T3Z0Qlkya1ZTVXNCTzY5UVhJOHlrTjlkTGhvbS82dEMKS3J0TDVMTnhSV0tJeWQ1MkdZV0dlcnU2Wm83a1NjbitXSS9aOXdBZU1qZDFaYm92SkgzNHoxUmdETmZuNVdGVAp1cXB0dCs3RmgvZXpyQVFPejkxdDV0cFNrVVBtZFI5M25wMG1jV01DT1hBMVNhRFlNbEkxdEoxa1ZlVE83bkVDCkF3RUFBYU5UTUZFd0hRWURWUjBPQkJZRUZBRUJ3bFNvNFVodnpDS3o3OE5KNFRXK05jZUdNQjhHQTFVZEl3UVkKTUJhQUZBRUJ3bFNvNFVodnpDS3o3OE5KNFRXK05jZUdNQThHQTFVZEV3RUIvd1FGTUFNQkFmOHdEUVlKS29aSQpodmNOQVFFTEJRQURnZ0lCQUZPdnUvd0pVaTIzWHR0NWhvcFJQR0hCSlNsZzM5RHhQR1VkRXBwcTQ0OUFGWFJDCmVoc0FycEdFNGo0WTRXK3hzRE5YTGxHdkhJSnQ3VmlYZ2ZaeERyeWRwM1NNalNYSFNMRkR6cEI1ZVJzOXE3Ym0KbFVtTnk3empSN1ZKdHFTMWJESU1wRHNra2M1eVQzd2daV2VLc2FvNFdhVUpvQ0YwbEpJbnBkK3M2Z1VKeVozNAp2TkxhTzJrc2ZWVmJpV0dwYXlRVmZmRlZJS3BiV3ZQVHB5Z0pmSU1NSUpVOEdESk11T1QyY083M25HT2hLakVBCm0yMUZuNmkzUm9WSEZPUTF2VVFhOGlhbFc5QXFxeWlCcWF3OFlVREpYZm9JSEc5cGxWSGJtajh2bGFQSVBUM2wKSXduUGZKRFF2dktlZVpjcmpQWDJyOVR3VC9wd0VOZVRnVDNKSUdDRkIyanpCMmRwUks5YmF1eWJhMUg4eEdPTwo5NWhhemI3eFg3bTNsY3FJNnZ1N3JRbEZobmZsbFVXQlJSZlZSaDJtbzZGOVNibkswdjl0N0ljSFFwbFdlS1NrCm9oWEpGSWJFbkp6TC9QWlBaZWhCWU5sLzluMlBwSmpqRDRQZHFoSXkzRExsMVVTVk1zRjcrRnFGNXlCeFRwS2gKRjBLemtib1dpckoyWHlUME5FY0tnemwzN05IQjRBQzlDZ0NwZ3VjdmNocnR3cjA1WjQyMUJQR0NZRC9Xd3ZQQwo0RVRNUkg5ODV3Q0ttZDU1di9vbnJtdmhSTUtIT2RsWDk1QURrVWxiQ2svZ1hoUi9UempWVnJhTzRwbUVjNUIyCjB0ZE10THlZTEovTXJXdjJqTWNzQXdlZVJBaEEyMkVmZmtYcnBQbkhPTzRIRHREc1YwS0NldWphcmtLaAotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==|g' kustomize/secret.yaml --debug"

    #  - name: Apply Kubernetes Manifests
     #   run: |
          
         # kubectl apply -k kustomize
         

