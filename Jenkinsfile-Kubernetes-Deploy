pipeline {
    agent any
    
    environment {
        KUBECONFIG = "/path/to/deployment.yaml"
        KUBECONFIG_1 = "/path/to/mateo-pokeapp-dev.yaml"
    }
    
    stages {
      stage('install') {
        steps {
          git(branch: 'develop', url: 'https://github.com/mateo546/My-App.git')
          sh 'npm install'
        }
      }
        
      stage('Deploy') {
        steps {
          withCredentials(bindings: [azureServicePrincipal("azure-service-principal")]) {
            sh 'az login --service-principal -u ${AZURE_CLIENT_ID} -p ${AZURE_CLIENT_SECRET} --tenant ${AZURE_TENANT_ID}'
            //el comando a continuacion se conecta a azure y descarga las credenciales necesarias para acceder al cl√∫ster de Kubernetes.
            sh "az aks get-credentials --resource-group SOCIUSRGLAB-RG-MODELODEVOPS-AKS --name ModeloDevOps-AKS"                
            //con las credenciales extraidas de azure y ya conectado al cluster, se aplica el manifiesto.
            sh "kubectl apply -f mateo-pokeapp-dev"
            sh "kubectl apply -f deployment.yaml -n mateo-pokeapp-dev"
            //Posibles futuros archivos de ingress, testeo(locust) o metricas(prometheus)
          }
        }
      }
    }
            
    post {
        always {
            sh "kubectl rollout status deployment/My-App"
        }
    }
}
